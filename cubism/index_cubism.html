<!DOCTYPE html>
<html lang="en" xmlns="//www.w3.org/1999/xhtml">

<head>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.0/css/all.css"
        integrity="sha384-Mmxa0mLqhmOeaE8vgOSbKacftZcsNYDjQzuCOm6D02luYSzBG8vpaOykv9lFQ51Y" crossorigin="anonymous">
    <meta charset="utf-8">
    <title>COVID-19 | Romania</title>
    <style>
        @import url(//fonts.googleapis.com/css?family=Yanone+Kaffeesatz:400,700);
        @import url(style.css);
    </style>
</head>

<div id="body"></div>

<script src="https://www.google.com/jsapi"></script>
<script src="d3.v2.js"></script>
<script src="cubism.v1.js"></script>
<script src="highlight.min.js"></script>
<script>
    google.load("visualization", "1");
    google.setOnLoadCallback(init);

    function data_lists_to_object_array(data, skip_row = 0, skip_col = 0) {
        var dummy = [];
        var keys = data[skip_row]
        for (i = 1 + skip_row; i < data.length; i++) {
            var d = {};
            for (j = skip_col; j < keys.length; j++) {
                d[keys[j]] = data[i][j];
            }
            dummy.push(d);
        }
        return dummy
    }

    function data_to_lists(data, n_col) {
        var ColumnNames = []
        var DataArray = new Array(data.getNumberOfRows());

        for (var col = 0; col < n_col; col++) {
            ColumnNames.push(data.getColumnLabel(col))
        }
        for (var row = 0; row < data.getNumberOfRows(); row++) {
            DataArray[row] = new Array(n_col);
            for (var col = 0; col < n_col; col++) {
                DataArray[row][col] = data.getValue(row, col);
            }
        }
        return [ColumnNames].concat(DataArray)
    }

    function transpose(matrix) {
        return matrix[0].map((col, i) => matrix.map(row => row[i]));
    }

    function getKeyValues(data, key) {
        var dummy = [];
        for (i = 0; i < data.length; i++) {
            dummy.push(data[i][key])
        }
        return dummy
    }

    function getMax(data, key) {
        return Math.max.apply(Math, data.map(function (o) {
            return o[key];
        }))
    }

    function sortObject(objs, key) {
        return objs.sort((a, b) => (a[key] > b[key]) ? 1 : ((b[key] > a[key]) ? -1 : 0));
    }

    function object_to_matrix(data, key) {
        var dummy = {};
        for (i = 0; i < data.length; i++) {
            d = {}
            Object.keys(data[i]).forEach(function (j) {
                if (j != key) {
                    d[j] = data[i][j]
                }
            })
            dummy[data[i][key]] = d
        }
        return dummy
    }

    function populate_ui(params) {
        var logo = body.append('a').attr('href', params['logo_link'][lang]).attr('target', '_blank').attr('id', 'logo').attr('class', params['logo_link']['UI'])
        logo.append('img').attr('src', params['logo_img'][lang]).attr('class', params['logo_img']['UI'])
        body.append('h1').html(params['title'][lang]).attr('id', 'title').attr('class', params['title']['UI'])
        body.append('h2').html(params['subtitle'][lang]).attr('id', 'subtitle').attr('class', params['subtitle']['UI'])
        new Array('main', 'status', 'global', 'governance', 'stocks', 'firms', 'industry', 'exports').forEach(function (section) {
            var sec = body.append('section').attr('id', section + '_section').attr('class', 'section');
            sec.append('h2').html(params[section][lang]).attr('class', params[section]['UI'])
            sec.append('p').html(params[section + '_content'][lang]).attr('class', params[section + '_content']['UI'])
            sec.append('div').attr('id', section)
        })

    }

    function render_graphs(params, all_data) {
        Object.keys(all_data).forEach(function (key) {
            console.log(key)
            var metric = context.metric(function (start, stop, step, callback) {
                callback(null, getKeyValues(all_data[key], 'cases'));
            }, name);

            d3.select("#" + key).call(function (div) {
                if (key == 'main') {
                    div.append("div")
                        .attr("class", "axis")
                        .call(context.axis().ticks(3).orient("top"));
                    div.append("div")
                        .attr("class", "rule")
                        .call(context.rule());
                }
                div.datum(metric);
                div.append("div")
                    .attr("class", "horizon")
                    .call(context.horizon()
                        .height(200)
                        .colors(["#08519c", "#3182bd", "#6baed6", "#bdd7e7", "#bae4b3", "#74c476", "#31a354", "#006d2c"])
                        .title(key)
                        .extent([0, 1000])
                        .scale(d3.scale.linear().domain([-100, 10]).range([-100, 1000]))
                    )

            });
        })
        context.stop()
    }

    // INIT AND SET PARAMETERS
    GSheetID = '1znjlYZavONVrlu-iIFw-s-CxjVAAOdvTSFtHrPcoPO4';
    var all_data = [];
    var lang = 'HU';
    var body = d3.select('#body');

    //INIT GRAPHS
    var step = 1000 * 60 * 60 * 24;
    var context = cubism.context()
        // .serverDelay(0)
        // .serverDelay(new Date(2020, 4, 2) - Date.now())
        .clientDelay(0)
        .step(step)
        .size(400)

    function init() {

        var GSheetName = 'Szotar'
        var query1 = new
            google.visualization.Query("https://docs.google.com/spreadsheet/ccc?key=" + GSheetID + '&sheet=' + GSheetName);
        query1.setQuery("");
        query1.send(handleQueryResponse1);

        function handleQueryResponse1(response) {
            var data = response.getDataTable();

            var params = data_to_lists(data, 5) //data.getNumberOfColumns()
            var params = object_to_matrix(data_lists_to_object_array(params, skip_row = 1), 'ID');

            // console.log(params)
            // FINISHED PARAMS LOADING

            var GSheetName = 'governance'
            var query2 = new
                google.visualization.Query("https://docs.google.com/spreadsheet/ccc?key=" + GSheetID + '&sheet=' + GSheetName);
            query2.setQuery("");
            query2.send(handleQueryResponse2);

            function handleQueryResponse2(response) {
                var data = response.getDataTable();

                var sheet_data = data_to_lists(data, 12) //data.getNumberOfColumns()
                sheet_data = data_lists_to_object_array(sheet_data);
                sortObject(sheet_data, 'date')
                all_data['main'] = sheet_data;
                all_data['status'] = sheet_data;
                all_data['governance'] = sheet_data;

                console.log(all_data)
                // FINISHED DATA LOADING

                populate_ui(params)
                // FINISHED BUILDING UI

                render_graphs(params, all_data)
                // FINISHED BUILDING UI

            }

        }
    }

    // On mousemove, reposition the chart values to match the rule.
    context.on("focus", function (i) {
        d3.selectAll(".value").style("right", i == null ? null : context.size() - i + "px");
    });
</script>

</html>